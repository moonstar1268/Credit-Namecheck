<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CreditTalk 본인인증</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:2rem;text-align:center;background:#f9fafb}
    #wrap{max-width:420px;margin:auto}
    button{padding:.8rem;font-size:1rem;width:100%;margin-top:2rem;background:#3478ff;border:0;color:#fff;border-radius:4px;cursor:pointer}
  </style>
  <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>
<div id="wrap">
  <h2>본인인증 요청</h2>
  <p>“본인인증” 버튼을 눌러 휴대폰 본인확인을 진행하세요.</p>
  <button id="certBtn">본인인증</button>
</div>

<script>
const qs = new URLSearchParams(location.search);
const merchant_uid  = qs.get('id');                 // 필수
const expectedPhone = (qs.get('expectedPhone') || '').replace(/\D/g,''); // 전화번호 고정값(숫자만)
const expectedName  = qs.get('expectedName') || ''; // 선택: 이름 고정값
const carrierParam  = qs.get('carrier') || '';      // 선택: 'SKT;KTF' 등
const ageLimitParam = qs.get('ageLimit') || '';     // 선택: 최소 만 나이(숫자)
if(!merchant_uid){ alert('잘못된 접근입니다.'); history.back(); }

window.IMP.init('imp27065444');

document.getElementById('certBtn').onclick = () => {
  const customer = {};
  if (expectedPhone && /^\d{10,11}$/.test(expectedPhone)) {
    customer.phoneNumber = expectedPhone;      // 전화번호 고정
  }
  if (expectedName) {
    customer.fullName = expectedName;          // 이름 고정(옵션)
  }

  // 다날 특수 파라미터
  const danalBypass = { danal: {} };
  if (carrierParam) {
    danalBypass.danal.IsCarrier = carrierParam;  // 예: "SKT;KTF"
  }
  if (ageLimitParam && /^\d+$/.test(ageLimitParam)) {
    danalBypass.danal.AGELIMIT = parseInt(ageLimitParam, 10); // 예: 20
  }
  // KISA ePrivacy Clean 권장값
  danalBypass.danal.CPTITLE = 'credit-namecheck.netlify.app';

  window.IMP.certification(
    {
      pg            : 'danal',
      merchant_uid  : 'cert_' + Date.now(),
      popup         : true,
      m_redirect_url: `https://credit-namecheck.netlify.app/namecheck.html?id=${encodeURIComponent(merchant_uid)}`,
      customer,
      bypass: danalBypass
    },
    rsp => {
      const certImpUid = rsp?.imp_uid || null;
      forwardResult(rsp.success ? 'success' : 'fail', certImpUid);
    }
  );
};

// 모바일 리다이렉트 처리
if(qs.has('imp_success')){
  const certImpUid = qs.get('imp_uid') || null;
  const ok = qs.get('imp_success') === 'true';
  forwardResult(ok ? 'success' : 'fail', certImpUid);
}

async function forwardResult(result, cert_imp_uid){
  try{
    await fetch('https://credit-namecheck.onrender.com/api/verifyResult',{
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   : JSON.stringify({ merchant_uid, result, cert_imp_uid })
    });
  }finally{
    location.href = `https://credit-namecheck.netlify.app/done.html?status=${result}`;
  }
}
</script>
</body>
</html>
